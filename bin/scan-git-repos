#!/bin/bash
set -e

declare -a REPO_DIRS=(
    "$HOME/"
    "$HOME/.emacs.d/"
    "$HOME/.emacs.d/el-get"
    "$HOME/software/random/"
    "$HOME/software/my-repos/"
)

function get_history(){
    path=$1
    output=$2
    author=$3

    pushd $path &> /dev/null

    if [ -z $author ]; then
        git rev-list --all --pretty=raw > $output || true
    else
        git rev-list --all --pretty=raw --author $author > $output || true
    fi

    popd &> /dev/null
}

# Echo path if it is git repo,  othrwise all subdirectories which are git
# repositories.
function get_repos () {
    path=$1
    if [ -d $path/.git ]; then
        echo $path
    else
        find $path -maxdepth 3 -name .git -type d -exec dirname {} \;
    fi
}

function scan_and_dump_output () {
    OUTPUT=$1
    AUTHOR=$2
    TEMP=/tmp/scan-tags.txt
    for D in "${REPO_DIRS[@]}"
    do
        for R in `get_repos $D`
        do
            REPO=`basename $R`
            get_history $R $TEMP $AUTHOR
            if [ -s $TEMP ]
            then
                memacs_git.py -e "ISO-8859-1" -f $TEMP -r $REPO -a -o $OUTPUT
            fi
        done
    done
}

scan_and_dump_output "$@"
