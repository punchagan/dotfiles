#!/bin/bash

ACTION="${1:-generate}"
DAY="${2:-last Friday}"
WEEK=$(date -d "${DAY}" '+%U')
YEAR=$(date -d "${DAY}" '+%G')
ROOT="${HOME}/code/segfault/admin"
DIR="${ROOT}/weekly/${YEAR}/${WEEK}"
WEEKLY="${DIR}/$(whoami).md"

commit () {
    pushd "${ROOT}" || exit
    git add "${WEEKLY}"
    git commit -m "Add @punchagan ${YEAR}-${WEEK} weekly"
    popd || exit
}

generate () {
    echo "Generating weekly for week ${WEEK} (in ${YEAR})..."
    switch=$(opam switch show)
    opam switch okra > /dev/null
    eval "$(opam env)"
    mkdir -p "${DIR}"
    okra generate --week="${WEEK}" > "${WEEKLY}"
    echo "Generated ${WEEKLY}"
    opam switch "${switch}" > /dev/null
    eval "$(opam env)"
}

lint () {
    switch=$(opam switch show)
    opam switch okra > /dev/null
    eval "$(opam env)"
    okra lint --engineer "${WEEKLY}"
    opam switch "${switch}" > /dev/null
    eval "$(opam env)"
}


if [[ $ACTION == "generate" ]];
then
    generate
elif [[ $ACTION == "lint" ]];
then
    lint
elif [[ $ACTION == "commit" ]];
then
    commit
else
    echo "Unknown action: ${ACTION}"
fi
